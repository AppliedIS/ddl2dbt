{{ config(tags = ['policy'], materialized = 'table') }}

{%- set metadata_yaml -%}
source_model: 'stg_peak_policy'
src_pk: 'POLICY_HK'
src_hashdiff: 'HASHDIFF'
src_eff: 'EFFECTIVEDATE'
src_ldts: 'LOAD_TIMESTAMP'
src_source: 'RECORD_SOURCE'
src_payload:
  - 'TRANSACTION_HK'
  - 'EFFECTIVE_TIMESTAMP'
  - 'POLICY_NUMBER'
  - 'POLICYREADONLYHISTORYID'
  - 'INCLUDEDELETED'
  - 'PRODUCTKIND'
  - 'RETRIEVEPOLICY_ID'
  - 'DATA_ID'
  - 'POLICY_ID'
  - 'ACCOUNTID'
  - 'AGENTID'
  - 'AIPVOLUNTARYRATEINDICATOR'
  - 'APPLICATIONORIGINALWRITTENDATE'
  - 'AVAILABLEVEHICLENUMBERID'
  - 'CANCELLATIONDATE'
  - 'CAPPINGPREVIOUSLOBCODE'
  - 'COMPANYINCEPTIONDATE'
  - 'CONTRACTOVERRIDE'
  - 'CONTRACTREVIEWDATE'
  - 'CONTRACTTYPE'
  - 'CONTRACTTYPEASSIGNDATE'
  - 'CORPORATEINCEPTIONDATE'
  - 'CTRAUTHORIZATIONSTATUS'
  - 'CTRRECEIVEDDATE'
  - 'CTRSENTDATE'
  - 'DECLINEOVERRIDE'
  - 'DECLINEOVERRIDEUSER'
  - 'DECPACKAGETYPECODE'
  - 'DEPENDENTS'
  - 'EFFECTIVETYPECODE'
  - 'EXPIRATIONDATE'
  - 'FASTTRACKRENEWALINDICATOR'
  - 'GDRNAME'
  - 'INCEPTIONDATE'
  - 'INSURANCETYPE'
  - 'ISFULLCOVERAGE'
  - 'ISINTERNETSALE'
  - 'ISRENEWALQUESTIONNAIREREQUIRED'
  - 'ISSHORTTERMPOLICY'
  - 'LASTCHANGEDINSURANCETYPE'
  - 'LASTCHANGEDLIFESEGMENT'
  - 'LASTCHANGEDLOBCODE'
  - 'LASTCHANGEDPRIMARYRATINGSTATE'
  - 'LASTCHANGEDRISKSEGMENT'
  - 'LASTCHANGEDWRITINGCOMPANY'
  - 'LEGACYSYSTEMACTIVITYDATE'
  - 'LIFESEGMENT'
  - 'LIFESEGMENTINCEPTIONDATE'
  - 'LOBCODE'
  - 'MINIMUMPREMIUM'
  - 'MINIMUMPREMIUMWRITTEN'
  - 'NONCANCELLABLE'
  - 'NONOWNEDAUTOCOVERAGETYPE'
  - 'OPTIONFORMRECEIVEDINDICATOR'
  - 'OPTIONFORMREQUIREDINDICATOR'
  - 'ORIGINALPOLICYEFFECTIVEDATE'
  - 'PAPERLESSPOLICYSTATUS'
  - 'PAPERLESSPOLICYSTATUSDATE'
  - 'PARTIALPAPERLESSSTATUS'
  - 'PAYPLAN'
  - 'POLICYBINDERDATETIMESTAMP'
  - 'POLICYCLAIMSIDENTIFIER'
  - 'POLICYNUMBER'
  - 'POLICYTERMID'
  - 'PREMIUM'
  - 'PREMIUMCHANGE'
  - 'PREMIUMWRITTEN'
  - 'PRIMARYRATINGSTATE'
  - 'PRODUCT'
  - 'PRORATEDADJUSTMENTAMOUNT'
  - 'PROXYSTATUSCOUNTER'
  - 'RATINGTIER'
  - 'REASONAMENDMENTCODE'
  - 'REISSUEWITHLAPSEDATE'
  - 'REISSUEWITHLAPSEEFFECTIVEDATE'
  - 'RELATIONTOPRIORPOLICYAPPLICANT'
  - 'RENEWALSTATUS'
  - 'REQUESTEDMAILPACKAGECODE'
  - 'RETENTIONKEY'
  - 'RETURNEDMAILINDICATOR'
  - 'RISKSEGMENT'
  - 'RISKSEGMENTINCEPTIONDATE'
  - 'SALESTYPE'
  - 'SOURCEOFADVERTISING'
  - 'SOURCEOFBUSINESS'
  - 'STATESTANDARDPOLICYINDICATOR'
  - 'STATETENURESTARTDATE'
  - 'STATUS'
  - 'SUPPRESSDOCUMENTOUTPUT'
  - 'TENUREPOLICYYEARS'
  - 'TERM'
  - 'TERMFACTOR'
  - 'TEXASPROXYSTATUS'
  - 'UMBRELLAREFERRAL'
  - 'WASBALANCEOVERRIDDEN'
  - 'WRITINGCOMPANY'
{%- endset -%}

{% set metadata_dict = fromyaml(metadata_yaml) -%}
{% set source_model = metadata_dict['source_model'] -%}
{% set src_pk = metadata_dict['src_pk'] -%}
{% set src_hashdiff = metadata_dict['src_hashdiff'] -%}
{% set src_payload = metadata_dict['src_payload'] -%}
{% set src_eff = metadata_dict['src_eff'] -%}
{% set src_ldts = metadata_dict['src_ldts'] -%}
{% set src_source = metadata_dict['src_source'] -%}

{{ dbtvault.sat(src_pk=src_pk, 
                src_hashdiff=src_hashdiff, 
                src_payload=src_payload,
                src_eff=src_eff, 
                src_ldts=src_ldts,
                src_source=src_source,
                source_model=source_model) }}